<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚫ BLACK TERMINAL</title>
    <style>
        /* ОСНОВНЫЕ СТИЛИ */
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #111118;
            --bg-panel: #0d0d14;
            --border: #22222a;
            --primary: #00d4ff;
            --success: #00ff88;
            --danger: #ff3366;
            --warning: #ffaa00;
            --text: #ffffff;
            --text-secondary: #888899;
            --gradient-dark: linear-gradient(135deg, #0a0a0f 0%, #151522 100%);
            --gradient-card: linear-gradient(135deg, #111118 0%, #1a1a22 100%);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
        }
        
        body {
            background: var(--gradient-dark);
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        /* СКРОЛЛБАР */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
        
        /* HEADER */
        .header {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: var(--shadow);
            position: relative;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(90deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }
        
        .balance-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .balance-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .balance-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }
        
        .balance-value {
            font-size: 16px;
            font-weight: 600;
        }
        
        .balance-value.positive {
            color: var(--success);
        }
        
        .balance-value.negative {
            color: var(--danger);
        }
        
        /* ОСНОВНОЙ КОНТЕЙНЕР */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        /* ПАНЕЛЬ ГРАФИКА */
        .chart-section {
            flex: 0 0 55vh;
            min-height: 300px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .chart-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }
        
        .symbol-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .symbol-name {
            font-size: 18px;
            font-weight: 600;
        }
        
        .price-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .current-price {
            font-size: 18px;
            font-weight: 600;
        }
        
        .price-change {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .price-change.positive {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
        }
        
        .price-change.negative {
            background: rgba(255, 51, 102, 0.1);
            color: var(--danger);
        }
        
        .chart-tools {
            display: flex;
            gap: 8px;
        }
        
        .tool-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .tool-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .chart-container {
            flex: 1;
            position: relative;
        }
        
        #tradingview_chart {
            width: 100%;
            height: 100%;
        }
        
        /* ПАНЕЛЬ РЫНКОВ */
        .markets-section {
            flex: 0 0 25vh;
            min-height: 200px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        
        .markets-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }
        
        .markets-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .market-search {
            width: 200px;
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 12px;
        }
        
        .markets-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            padding: 12px;
            overflow-y: auto;
        }
        
        .market-card {
            background: var(--gradient-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .market-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .market-card.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 212, 255, 0.05) 100%);
        }
        
        .market-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .market-symbol {
            font-size: 14px;
            font-weight: 600;
        }
        
        .market-price {
            font-size: 14px;
            font-weight: 600;
        }
        
        .market-card-body {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .market-name {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .market-change {
            font-size: 12px;
            font-weight: 600;
        }
        
        .market-change.positive {
            color: var(--success);
        }
        
        .market-change.negative {
            color: var(--danger);
        }
        
        /* ПАНЕЛЬ ТОРГОВЛИ */
        .trade-section {
            flex: 0 0 auto;
            background: var(--bg-panel);
            display: flex;
            flex-direction: column;
        }
        
        .trade-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }
        
        .trade-tabs {
            display: flex;
            gap: 1px;
            background: var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .trade-tab {
            padding: 10px 20px;
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .trade-tab:hover {
            color: var(--text);
        }
        
        .trade-tab.active {
            background: var(--primary);
            color: var(--bg-dark);
            font-weight: 600;
        }
        
        .position-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .current-position {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .position-symbol {
            font-weight: 600;
            color: var(--text);
        }
        
        .trade-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* ФОРМА ОРДЕРА */
        .order-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .position-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .position-btn {
            padding: 14px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .position-btn.long.active {
            border-color: var(--success);
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
        }
        
        .position-btn.short.active {
            border-color: var(--danger);
            background: rgba(255, 51, 102, 0.1);
            color: var(--danger);
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .input-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .input-field {
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .percent-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .percent-btn {
            padding: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .percent-btn:hover {
            background: var(--primary);
            color: var(--bg-dark);
        }
        
        .order-summary {
            background: var(--gradient-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-top: 8px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .summary-row:last-child {
            border-bottom: none;
            font-weight: 600;
            padding-top: 8px;
            margin-top: 8px;
            border-top: 1px solid var(--border);
        }
        
        .order-action {
            margin-top: 16px;
        }
        
        .order-btn {
            width: 100%;
            padding: 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .order-btn.long {
            background: var(--success);
            color: #000;
        }
        
        .order-btn.short {
            background: var(--danger);
            color: #fff;
        }
        
        .order-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* ПОЗИЦИИ */
        .positions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .position-card {
            background: var(--gradient-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        
        .position-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .position-symbol-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .position-symbol {
            font-size: 14px;
            font-weight: 600;
        }
        
        .position-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .position-type.long {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
        }
        
        .position-type.short {
            background: rgba(255, 51, 102, 0.1);
            color: var(--danger);
        }
        
        .position-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .stat-value {
            font-size: 13px;
            font-weight: 500;
        }
        
        .position-pnl {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
        }
        
        .position-pnl.positive {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
        }
        
        .position-pnl.negative {
            background: rgba(255, 51, 102, 0.1);
            color: var(--danger);
        }
        
        .position-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg-dark);
        }
        
        .action-btn.close {
            background: rgba(255, 51, 102, 0.1);
            color: var(--danger);
        }
        
        /* УВЕДОМЛЕНИЯ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            padding: 16px;
            border-radius: 8px;
            background: var(--gradient-card);
            border: 1px solid var(--border);
            color: var(--text);
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* АДАПТИВНОСТЬ */
        @media (max-width: 768px) {
            .header {
                padding: 10px;
            }
            
            .logo h1 {
                font-size: 16px;
            }
            
            .balance-stats {
                gap: 12px;
            }
            
            .balance-value {
                font-size: 14px;
            }
            
            .markets-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
            
            .position-stats {
                grid-template-columns: 1fr;
            }
            
            .trade-tabs {
                flex-wrap: wrap;
            }
            
            .trade-tab {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .chart-section {
                flex: 0 0 50vh;
            }
            
            .markets-section {
                flex: 0 0 30vh;
            }
            
            .markets-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            
            .position-selector {
                grid-template-columns: 1fr;
            }
            
            .percent-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="logo">
            <h1>⚫ BLACK TERMINAL</h1>
        </div>
        
        <div class="balance-stats">
            <div class="balance-item">
                <div class="balance-label">БАЛАНС</div>
                <div class="balance-value" id="totalBalance">$10,000.00</div>
            </div>
            <div class="balance-item">
                <div class="balance-label">PNL СЕГОДНЯ</div>
                <div class="balance-value positive" id="dailyPnl">+$450.30</div>
            </div>
        </div>
    </header>
    
    <!-- ОСНОВНОЙ КОНТЕЙНЕР -->
    <div class="main-container">
        <!-- ПАНЕЛЬ ГРАФИКА -->
        <section class="chart-section">
            <div class="chart-header">
                <div class="symbol-info">
                    <div class="symbol-name" id="currentSymbol">BTC/USDT</div>
                    <div class="price-info">
                        <div class="current-price" id="currentPrice">$42,150.30</div>
                        <div class="price-change positive" id="priceChange">+2.5%</div>
                    </div>
                </div>
                <div class="chart-tools">
                    <button class="tool-btn" title="Полный экран" onclick="toggleFullscreen()">⛶</button>
                    <button class="tool-btn" title="Обновить" onclick="refreshChart()">↻</button>
                </div>
            </div>
            <div class="chart-container">
                <div id="tradingview_chart"></div>
            </div>
        </section>
        
        <!-- ПАНЕЛЬ РЫНКОВ -->
        <section class="markets-section">
            <div class="markets-header">
                <div class="markets-title">РЫНКИ</div>
                <input type="text" class="market-search" placeholder="Поиск..." id="marketSearch">
            </div>
            <div class="markets-grid" id="marketGrid">
                <!-- Рыночные карточки загрузятся через JS -->
            </div>
        </section>
        
        <!-- ПАНЕЛЬ ТОРГОВЛИ -->
        <section class="trade-section">
            <div class="trade-header">
                <div class="trade-tabs">
                    <button class="trade-tab active" onclick="switchTab('order')">ОРДЕР</button>
                    <button class="trade-tab" onclick="switchTab('positions')">ПОЗИЦИИ</button>
                </div>
                <div class="position-info">
                    <div class="current-position">ТОРГУЕМ:</div>
                    <div class="position-symbol" id="tradeSymbol">BTC/USDT</div>
                </div>
            </div>
            
            <!-- ВКЛАДКА ОРДЕР -->
            <div class="trade-content" id="orderTab">
                <form class="order-form" onsubmit="placeOrder(event)">
                    <div class="position-selector">
                        <button type="button" class="position-btn long active" onclick="selectPositionType('long')">LONG</button>
                        <button type="button" class="position-btn short" onclick="selectPositionType('short')">SHORT</button>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">ОБЪЕМ (USDT)</label>
                            <input type="number" class="input-field" id="orderAmount" value="100" step="10" min="10" required>
                            <div class="percent-buttons">
                                <button type="button" class="percent-btn" onclick="setOrderAmount(25)">25%</button>
                                <button type="button" class="percent-btn" onclick="setOrderAmount(50)">50%</button>
                                <button type="button" class="percent-btn" onclick="setOrderAmount(75)">75%</button>
                                <button type="button" class="percent-btn" onclick="setOrderAmount(100)">100%</button>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">ПЛЕЧО</label>
                            <input type="number" class="input-field" id="leverage" value="3" step="1" min="1" max="10" required>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">СТОП-ЛОСС (USDT)</label>
                            <input type="number" class="input-field" id="stopLoss" value="40000">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">ТЕЙК-ПРОФИТ (USDT)</label>
                            <input type="number" class="input-field" id="takeProfit" value="44000">
                        </div>
                    </div>
                    
                    <div class="order-summary">
                        <div class="summary-row">
                            <span>Маржа:</span>
                            <span id="marginAmount">$33.33</span>
                        </div>
                        <div class="summary-row">
                            <span>Комиссия (0.1%):</span>
                            <span id="feeAmount">$0.10</span>
                        </div>
                        <div class="summary-row">
                            <span>Итого:</span>
                            <span id="totalAmount">$33.43</span>
                        </div>
                    </div>
                    
                    <div class="order-action">
                        <button type="submit" class="order-btn long" id="orderButton">ОТКРЫТЬ LONG</button>
                    </div>
                </form>
            </div>
            
            <!-- ВКЛАДКА ПОЗИЦИИ -->
            <div class="trade-content" id="positionsTab" style="display: none;">
                <div class="positions-list" id="positionsList">
                    <!-- Позиции загрузятся через JS -->
                </div>
            </div>
        </section>
    </div>
    
    <!-- УВЕДОМЛЕНИЯ -->
    <div id="notification" class="notification" style="display: none;"></div>

    <!-- TRADINGVIEW -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <script>
        // ==================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ====================
        const terminalState = {
            balance: 10000.00,
            freeBalance: 8500.00,
            dailyPnl: 450.30,
            positions: [],
            currentSymbol: 'BTCUSDT',
            currentPrice: 42150.30,
            positionType: 'long'
        };
        
        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        document.addEventListener('DOMContentLoaded', function() {
            initTradingView();
            loadMarkets();
            loadPositions();
            updateBalanceDisplay();
            updateOrderSummary();
            
            // Обновляем цену каждые 5 секунд (симуляция)
            setInterval(updatePrices, 5000);
            
            // Обновляем PNL позиций каждые 3 секунды
            setInterval(updatePositionsPnL, 3000);
        });
        
        // ==================== TRADINGVIEW ====================
        function initTradingView() {
            window.tvWidget = new TradingView.widget({
                "container_id": "tradingview_chart",
                "width": "100%",
                "height": "100%",
                "symbol": "BINANCE:BTCUSDT",
                "interval": "15",
                "timezone": "Europe/Moscow",
                "theme": "dark",
                "style": "1",
                "locale": "ru",
                "toolbar_bg": "#0d0d14",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": true,
                "save_image": true,
                "studies": [
                    "MASimple@tv-basicstudies",
                    "RSI@tv-basicstudies",
                    "BB@tv-basicstudies"
                ],
                "disabled_features": [
                    "header_symbol_search",
                    "use_localstorage_for_settings"
                ],
                "enabled_features": [
                    "study_templates",
                    "move_logo_to_main_pane"
                ]
            });
        }
        
        function refreshChart() {
            if (window.tvWidget) {
                window.tvWidget.setSymbol(terminalState.currentSymbol, '15');
            }
            showNotification('График обновлен');
        }
        
        function toggleFullscreen() {
            const chartContainer = document.querySelector('.chart-container');
            if (!document.fullscreenElement) {
                if (chartContainer.requestFullscreen) {
                    chartContainer.requestFullscreen();
                } else if (chartContainer.webkitRequestFullscreen) {
                    chartContainer.webkitRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
        }
        
        // ==================== РЫНКИ ====================
        function loadMarkets() {
            const markets = [
                { symbol: 'BTCUSDT', name: 'Bitcoin', price: 42150.30, change: 2.5 },
                { symbol: 'ETHUSDT', name: 'Ethereum', price: 2250.80, change: 1.8 },
                { symbol: 'SOLUSDT', name: 'Solana', price: 98.45, change: -0.5 },
                { symbol: 'XRPUSDT', name: 'Ripple', price: 0.62, change: 0.8 },
                { symbol: 'ADAUSDT', name: 'Cardano', price: 0.58, change: -1.2 },
                { symbol: 'DOTUSDT', name: 'Polkadot', price: 8.24, change: 0.5 },
                { symbol: 'BNBUSDT', name: 'Binance Coin', price: 305.20, change: 0.3 },
                { symbol: 'DOGEUSDT', name: 'Dogecoin', price: 0.085, change: -0.2 }
            ];
            
            const marketGrid = document.getElementById('marketGrid');
            marketGrid.innerHTML = '';
            
            markets.forEach(market => {
                const card = document.createElement('div');
                card.className = `market-card ${market.symbol === terminalState.currentSymbol ? 'active' : ''}`;
                card.dataset.symbol = market.symbol;
                card.dataset.price = market.price;
                card.dataset.change = market.change;
                
                card.innerHTML = `
                    <div class="market-card-header">
                        <div class="market-symbol">${market.symbol}</div>
                        <div class="market-price">$${formatPrice(market.price)}</div>
                    </div>
                    <div class="market-card-body">
                        <div class="market-name">${market.name}</div>
                        <div class="market-change ${market.change >= 0 ? 'positive' : 'negative'}">
                            ${market.change >= 0 ? '+' : ''}${market.change}%
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => selectMarket(market));
                marketGrid.appendChild(card);
            });
            
            // Поиск рынков
            document.getElementById('marketSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.market-card').forEach(card => {
                    const symbol = card.dataset.symbol.toLowerCase();
                    const isVisible = symbol.includes(searchTerm);
                    card.style.display = isVisible ? 'block' : 'none';
                });
            });
        }
        
        function selectMarket(market) {
            terminalState.currentSymbol = market.symbol;
            terminalState.currentPrice = market.price;
            
            // Обновляем UI
            document.getElementById('currentSymbol').textContent = market.symbol;
            document.getElementById('currentPrice').textContent = `$${formatPrice(market.price)}`;
            document.getElementById('priceChange').textContent = `${market.change >= 0 ? '+' : ''}${market.change}%`;
            document.getElementById('priceChange').className = `price-change ${market.change >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('tradeSymbol').textContent = market.symbol;
            
            // Обновляем активную карточку
            document.querySelectorAll('.market-card').forEach(card => {
                card.classList.remove('active');
            });
            event.target.closest('.market-card').classList.add('active');
            
            // Обновляем график
            if (window.tvWidget) {
                window.tvWidget.setSymbol(`BINANCE:${market.symbol}`, '15');
            }
            
            // Обновляем поля стоп-лосс и тейк-профит
            updateStopLevels(market.price);
            
            showNotification(`${market.name} выбран для торговли`);
        }
        
        function updateStopLevels(currentPrice) {
            const stopLossInput = document.getElementById('stopLoss');
            const takeProfitInput = document.getElementById('takeProfit');
            
            const stopLoss = currentPrice * 0.97; // -3%
            const takeProfit = currentPrice * 1.04; // +4%
            
            stopLossInput.value = Math.round(stopLoss);
            takeProfitInput.value = Math.round(takeProfit);
        }
        
        // ==================== ТОРГОВЛЯ ====================
        function selectPositionType(type) {
            terminalState.positionType = type;
            
            // Обновляем кнопки
            document.querySelectorAll('.position-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.position-btn.${type}`).classList.add('active');
            
            // Обновляем кнопку ордера
            const orderBtn = document.getElementById('orderButton');
            orderBtn.textContent = `ОТКРЫТЬ ${type.toUpperCase()}`;
            orderBtn.className = `order-btn ${type}`;
            
            updateOrderSummary();
        }
        
        function setOrderAmount(percent) {
            const amountInput = document.getElementById('orderAmount');
            const maxAmount = terminalState.freeBalance;
            const newAmount = Math.round(maxAmount * (percent / 100));
            amountInput.value = newAmount;
            updateOrderSummary();
        }
        
        function updateOrderSummary() {
            const amount = parseFloat(document.getElementById('orderAmount').value) || 100;
            const leverage = parseFloat(document.getElementById('leverage').value) || 3;
            
            const margin = amount / leverage;
            const fee = amount * 0.001; // 0.1% комиссия
            const total = margin + fee;
            
            document.getElementById('marginAmount').textContent = `$${margin.toFixed(2)}`;
            document.getElementById('feeAmount').textContent = `$${fee.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
        }
        
        function placeOrder(event) {
            event.preventDefault();
            
            const amount = parseFloat(document.getElementById('orderAmount').value);
            const leverage = parseFloat(document.getElementById('leverage').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);
            
            if (amount > terminalState.freeBalance) {
                showNotification('Недостаточно средств', 'error');
                return;
            }
            
            const margin = amount / leverage;
            const fee = amount * 0.001;
            const totalCost = margin + fee;
            
            // Создаем позицию
            const position = {
                id: Date.now(),
                symbol: terminalState.currentSymbol,
                type: terminalState.positionType,
                amount: amount,
                leverage: leverage,
                entryPrice: terminalState.currentPrice,
                currentPrice: terminalState.currentPrice,
                stopLoss: stopLoss,
                takeProfit: takeProfit,
                margin: margin,
                fee: fee,
                pnl: 0,
                pnlPercent: 0,
                timestamp: new Date().toLocaleTimeString()
            };
            
            // Обновляем баланс
            terminalState.freeBalance -= totalCost;
            terminalState.positions.push(position);
            
            // Обновляем UI
            updateBalanceDisplay();
            loadPositions();
            updateOrderSummary();
            
            showNotification(
                `${position.type.toUpperCase()} позиция ${position.symbol} открыта`,
                'success'
            );
            
            // Сбрасываем форму
            event.target.reset();
            document.getElementById('orderAmount').value = 100;
            document.getElementById('leverage').value = 3;
            updateStopLevels(terminalState.currentPrice);
            selectPositionType('long');
        }
        
        // ==================== ПОЗИЦИИ ====================
        function loadPositions() {
            const positionsList = document.getElementById('positionsList');
            
            if (terminalState.positions.length === 0) {
                positionsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        Нет открытых позиций
                    </div>
                `;
                return;
            }
            
            positionsList.innerHTML = '';
            
            terminalState.positions.forEach(position => {
                const card = document.createElement('div');
                card.className = 'position-card';
                card.dataset.id = position.id;
                
                const pnl = position.pnl;
                const pnlPercent = position.pnlPercent;
                
                card.innerHTML = `
                    <div class="position-card-header">
                        <div class="position-symbol-info">
                            <div class="position-symbol">${position.symbol}</div>
                            <div class="position-type ${position.type}">${position.type.toUpperCase()} ${position.leverage}x</div>
                        </div>
                        <div class="position-pnl ${pnl >= 0 ? 'positive' : 'negative'}">
                            ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)
                        </div>
                    </div>
                    
                    <div class="position-stats">
                        <div class="stat-item">
                            <div class="stat-label">Объем</div>
                            <div class="stat-value">$${position.amount.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Вход</div>
                            <div class="stat-value">$${position.entryPrice.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Текущая</div>
                            <div class="stat-value">$${position.currentPrice.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Маржа</div>
                            <div class="stat-value">$${position.margin.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div class="position-actions">
                        <button class="action-btn" onclick="addToPosition(${position.id})">ДОБАВИТЬ</button>
                        <button class="action-btn close" onclick="closePosition(${position.id})">ЗАКРЫТЬ</button>
                    </div>
                `;
                
                positionsList.appendChild(card);
            });
        }
        
        function updatePositionsPnL() {
            if (terminalState.positions.length === 0) return;
            
            let totalDailyPnl = 0;
            
            terminalState.positions.forEach(position => {
                // Симулируем изменение цены
                const randomChange = (Math.random() - 0.5) * 2; // -1% до +1%
                const newPrice = position.currentPrice * (1 + randomChange / 100);
                position.currentPrice = newPrice;
                
                // Рассчитываем PNL
                let pnl = 0;
                if (position.type === 'long') {
                    pnl = (newPrice - position.entryPrice) * (position.amount / position.entryPrice);
                } else {
                    pnl = (position.entryPrice - newPrice) * (position.amount / position.entryPrice);
                }
                
                // Умножаем на кредитное плечо
                pnl *= position.leverage;
                position.pnl = pnl;
                position.pnlPercent = (pnl / position.margin) * 100;
                
                // Проверяем стоп-лосс и тейк-профит
                if (position.type === 'long') {
                    if (newPrice <= position.stopLoss || newPrice >= position.takeProfit) {
                        closePosition(position.id, 'auto');
                    }
                } else {
                    if (newPrice >= position.stopLoss || newPrice <= position.takeProfit) {
                        closePosition(position.id, 'auto');
                    }
                }
                
                totalDailyPnl += pnl;
            });
            
            // Обновляем баланс
            terminalState.dailyPnl = totalDailyPnl;
            terminalState.balance = 10000 + totalDailyPnl; // Стартовый баланс + PNL
            
            // Обновляем UI
            updateBalanceDisplay();
            loadPositions();
        }
        
        function closePosition(positionId, source = 'manual') {
            const positionIndex = terminalState.positions.findIndex(p => p.id === positionId);
            if (positionIndex === -1) return;
            
            const position = terminalState.positions[positionIndex];
            const pnl = position.pnl;
            
            // Возвращаем маржу и добавляем PNL
            terminalState.freeBalance += position.margin + pnl;
            
            // Удаляем позицию
            terminalState.positions.splice(positionIndex, 1);
            
            // Обновляем UI
            updateBalanceDisplay();
            loadPositions();
            
            if (source === 'auto') {
                showNotification(
                    `${position.symbol} закрыт по ${pnl >= 0 ? 'тейк-профиту' : 'стоп-лоссу'}`,
                    pnl >= 0 ? 'success' : 'error'
                );
            } else {
                showNotification(
                    `Позиция ${position.symbol} закрыта. PNL: $${pnl.toFixed(2)}`,
                    pnl >= 0 ? 'success' : 'error'
                );
            }
        }
        
        function addToPosition(positionId) {
            const position = terminalState.positions.find(p => p.id === positionId);
            if (!position) return;
            
            const addAmount = 50; // USDT
            if (addAmount > terminalState.freeBalance) {
                showNotification('Недостаточно средств для добавления', 'error');
                return;
            }
            
            const additionalMargin = addAmount / position.leverage;
            const fee = addAmount * 0.001;
            
            position.amount += addAmount;
            position.margin += additionalMargin;
            position.fee += fee;
            
            terminalState.freeBalance -= (additionalMargin + fee);
            
            updateBalanceDisplay();
            loadPositions();
            showNotification(`Добавлено $${addAmount} к позиции ${position.symbol}`);
        }
        
        // ==================== УТИЛИТЫ ====================
        function updateBalanceDisplay() {
            document.getElementById('totalBalance').textContent = `$${terminalState.balance.toFixed(2)}`;
            
            const dailyPnlEl = document.getElementById('dailyPnl');
            dailyPnlEl.textContent = `${terminalState.dailyPnl >= 0 ? '+' : ''}$${terminalState.dailyPnl.toFixed(2)}`;
            dailyPnlEl.className = `balance-value ${terminalState.dailyPnl >= 0 ? 'positive' : 'negative'}`;
        }
        
        function updatePrices() {
            // Симуляция изменения цен на рынках
            document.querySelectorAll('.market-card').forEach(card => {
                const currentPrice = parseFloat(card.dataset.price);
                const change = parseFloat(card.dataset.change);
                
                // Небольшое случайное изменение
                const randomChange = (Math.random() - 0.5) * 0.2; // -0.1% до +0.1%
                const newPrice = currentPrice * (1 + randomChange / 100);
                const newChange = change + randomChange;
                
                card.dataset.price = newPrice;
                card.dataset.change = newChange;
                
                if (card.classList.contains('active')) {
                    terminalState.currentPrice = newPrice;
                    document.getElementById('currentPrice').textContent = `$${formatPrice(newPrice)}`;
                    
                    const priceChangeEl = document.getElementById('priceChange');
                    priceChangeEl.textContent = `${newChange >= 0 ? '+' : ''}${newChange.toFixed(2)}%`;
                    priceChangeEl.className = `price-change ${newChange >= 0 ? 'positive' : 'negative'}`;
                }
                
                // Обновляем отображение цены
                const priceElement = card.querySelector('.market-price');
                const changeElement = card.querySelector('.market-change');
                
                priceElement.textContent = `$${formatPrice(newPrice)}`;
                changeElement.textContent = `${newChange >= 0 ? '+' : ''}${newChange.toFixed(2)}%`;
                changeElement.className = `market-change ${newChange >= 0 ? 'positive' : 'negative'}`;
            });
        }
        
        function formatPrice(price) {
            if (price >= 1000) {
                return price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else if (price >= 1) {
                return price.toFixed(2);
            } else {
                return price.toFixed(4);
            }
        }
        
        function switchTab(tabName) {
            // Обновляем кнопки вкладок
            document.querySelectorAll('.trade-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.trade-tab:nth-child(${tabName === 'order' ? 1 : 2})`).classList.add('active');
            
            // Показываем соответствующую вкладку
            document.getElementById('orderTab').style.display = tabName === 'order' ? 'block' : 'none';
            document.getElementById('positionsTab').style.display = tabName === 'positions' ? 'block' : 'none';
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            // Цвет в зависимости от типа
            if (type === 'error') {
                notification.style.borderColor = 'var(--danger)';
                notification.style.background = 'linear-gradient(135deg, rgba(255, 51, 102, 0.1) 0%, rgba(255, 51, 102, 0.05) 100%)';
            } else if (type === 'success') {
                notification.style.borderColor = 'var(--success)';
                notification.style.background = 'linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.05) 100%)';
            } else {
                notification.style.borderColor = 'var(--primary)';
                notification.style.background = 'var(--gradient-card)';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Инициализация событий
        document.getElementById('orderAmount').addEventListener('input', updateOrderSummary);
        document.getElementById('leverage').addEventListener('input', updateOrderSummary);
    </script>
</body>
</html>
